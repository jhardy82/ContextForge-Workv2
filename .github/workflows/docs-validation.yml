name: Documentation Validation

on:
  push:
    branches: [main, develop]
    paths:
      - 'docs/**/*.md'
      - 'projects/**/*.md'
      - '**README.md'
      - '.github/workflows/docs-validation.yml'
  pull_request:
    paths:
      - 'docs/**/*.md'
      - 'projects/**/*.md'
      - '**README.md'
      - '.github/workflows/docs-validation.yml'
  workflow_dispatch:

jobs:
  link-checker:
    name: Check Documentation Links
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check links with lychee
        uses: lycheeverse/lychee-action@v1
        with:
          # Check all markdown files in docs and projects
          args: |
            --verbose
            --no-progress
            --accept 200,201,202,204,301,302,307,308,429
            --timeout 30
            --max-redirects 5
            --max-retries 3
            --exclude 'localhost|127\.0\.0\.1|example\.com'
            --exclude-path '.git'
            --exclude-path 'node_modules'
            --exclude-path '__pycache__'
            'docs/**/*.md'
            'projects/**/*.md'
            '**/README.md'
          # Fail on broken links
          fail: true
          # Output format
          format: markdown
          # Generate job summary
          jobSummary: true

      - name: Create link check report
        if: failure()
        run: |
          echo "## :x: Broken Links Found" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Link validation failed. Please fix broken links before merging." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See job artifacts for detailed report." >> $GITHUB_STEP_SUMMARY

  markdown-lint:
    name: Lint Markdown Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install markdownlint-cli
        run: npm install -g markdownlint-cli

      - name: Run markdownlint
        run: |
          # Create markdownlint config if it doesn't exist
          if [ ! -f .markdownlint.json ]; then
            cat > .markdownlint.json << 'EOF'
          {
            "default": true,
            "MD013": false,
            "MD033": false,
            "MD041": false,
            "MD046": false
          }
          EOF
          fi

          # Run markdownlint
          markdownlint \
            'docs/**/*.md' \
            'projects/**/*.md' \
            '**/README.md' \
            --config .markdownlint.json \
            --ignore node_modules \
            --ignore __pycache__ \
            --ignore .git

      - name: Create markdown lint report
        if: failure()
        run: |
          echo "## :warning: Markdown Linting Issues Found" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please fix markdown formatting issues before merging." >> $GITHUB_STEP_SUMMARY

  documentation-completeness:
    name: Check Documentation Completeness
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for README files in major directories
        run: |
          echo "## Documentation Completeness Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Directories that should have READMEs
          REQUIRED_DIRS=(
            "python"
            "docs"
            "projects"
            "TaskMan-v2"
            ".github"
          )

          MISSING_READMES=()

          for dir in "${REQUIRED_DIRS[@]}"; do
            if [ -d "$dir" ] && [ ! -f "$dir/README.md" ]; then
              MISSING_READMES+=("$dir")
            fi
          done

          if [ ${#MISSING_READMES[@]} -eq 0 ]; then
            echo ":white_check_mark: All required directories have README files" >> $GITHUB_STEP_SUMMARY
          else
            echo ":warning: Missing README files in:" >> $GITHUB_STEP_SUMMARY
            for dir in "${MISSING_READMES[@]}"; do
              echo "- \`$dir/\`" >> $GITHUB_STEP_SUMMARY
            done
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Consider adding README files using the template at \`.github/templates/README.template.md\`" >> $GITHUB_STEP_SUMMARY
            # Make this advisory, not blocking
            exit 0
          fi

      - name: Validate README index coverage
        continue-on-error: true
        run: |
          if ! python scripts/validate_readme_index.py; then
            echo ":warning: README_INDEX.md drift detected. See job logs for missing/stale entries." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo ":white_check_mark: README_INDEX.md matches current README inventory." >> $GITHUB_STEP_SUMMARY
          fi

  documentation-summary:
    name: Generate Documentation Summary
    runs-on: ubuntu-latest
    needs: [link-checker, markdown-lint, documentation-completeness]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Count documentation files
        run: |
          echo "## :books: Documentation Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count markdown files
          TOTAL_MD=$(find . -name "*.md" -not -path "*/node_modules/*" -not -path "*/.git/*" -not -path "*/__pycache__/*" | wc -l)
          DOCS_MD=$(find docs -name "*.md" 2>/dev/null | wc -l || echo 0)
          PROJECTS_MD=$(find projects -name "*.md" 2>/dev/null | wc -l || echo 0)
          READMES=$(find . -name "README.md" -not -path "*/node_modules/*" -not -path "*/.git/*" | wc -l)

          echo "| Category | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Total Markdown Files** | $TOTAL_MD |" >> $GITHUB_STEP_SUMMARY
          echo "| **Documentation Files** | $DOCS_MD |" >> $GITHUB_STEP_SUMMARY
          echo "| **Project Documentation** | $PROJECTS_MD |" >> $GITHUB_STEP_SUMMARY
          echo "| **README Files** | $READMES |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check job results
          if [ "${{ needs.link-checker.result }}" = "success" ] && [ "${{ needs.markdown-lint.result }}" = "success" ]; then
            echo ":white_check_mark: **All documentation validation checks passed!**" >> $GITHUB_STEP_SUMMARY
          else
            echo ":x: **Some documentation validation checks failed. Please review above.**" >> $GITHUB_STEP_SUMMARY
          fi
