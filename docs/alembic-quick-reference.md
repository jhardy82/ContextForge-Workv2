# Alembic Migration Quick Reference Commands

**Database**: PostgreSQL 172.25.14.122:5432/taskman_v2
**Project**: TaskMan-v2
**Created**: 2025-12-25

---

## Prerequisites

```powershell
# Ensure Python virtual environment is activated
& .venv\Scripts\Activate.ps1

# Verify Alembic is installed
python -m pip show alembic

# If not installed:
python -m pip install alembic psycopg2-binary sqlalchemy
```

---

## Initial Setup (First-Time Only)

### 1. Initialize Alembic

```powershell
# Navigate to workspace root
cd C:\Users\James\Documents\Github\GHrepos\SCCMScripts

# Initialize Alembic (creates alembic.ini and alembic/ directory)
python -m alembic init alembic
```

**Expected Output**:
```
Creating directory alembic ... done
Creating directory alembic\versions ... done
Generating alembic.ini ... done
Generating alembic\env.py ... done
Generating alembic\README ... done
Generating alembic\script.py.mako ... done
```

### 2. Configure Database Connection

Edit `alembic.ini` (line ~58):

```ini
# BEFORE:
sqlalchemy.url = driver://user:pass@localhost/dbname

# AFTER:
sqlalchemy.url = postgresql://contextforge:contextforge@172.25.14.122:5432/taskman_v2
```

### 3. Test Database Connection

```powershell
# Create test script
@"
from sqlalchemy import create_engine, text
engine = create_engine('postgresql://contextforge:contextforge@172.25.14.122:5432/taskman_v2')
with engine.connect() as conn:
    result = conn.execute(text('SELECT version();'))
    print(f'Connected to: {result.scalar()}')
"@ | python
```

**Expected Output**: `Connected to: PostgreSQL 16.x ...`

---

## Daily Workflow Commands

### Check Current Migration Status

```powershell
# Show current database version
python -m alembic current

# Show migration history with current position
python -m alembic history --indicate-current

# Show detailed history
python -m alembic history --verbose
```

**Example Output**:
```
<base> -> 84456d47e6aa (head), add contextforge extended project schema
```

### Generate Migration from Model Changes

```powershell
# Auto-generate migration after editing models.py
python -m alembic revision --autogenerate -m "add_task_complexity_score"

# Review generated migration file
cat alembic\versions\<revision>_add_task_complexity_score.py
```

**IMPORTANT**: Always review autogenerated migrations before applying!

### Apply Migrations

```powershell
# Apply all pending migrations
python -m alembic upgrade head

# Apply to specific revision
python -m alembic upgrade <revision>

# Dry-run (generate SQL without executing)
python -m alembic upgrade head --sql > migration_preview.sql
type migration_preview.sql
```

### Rollback Migrations

```powershell
# Rollback one migration
python -m alembic downgrade -1

# Rollback to specific revision
python -m alembic downgrade <revision>

# Rollback to base (WARNING: drops all tables)
python -m alembic downgrade base

# Dry-run rollback
python -m alembic downgrade -1 --sql
```

### Stamp Database (Mark Revision Without Running)

```powershell
# Stamp database as being at a specific revision
# (Useful after manual schema changes or baseline creation)
python -m alembic stamp <revision>

# Stamp as head (latest)
python -m alembic stamp head

# Verify stamping
python -m alembic current
```

---

## Advanced Operations

### Create Empty Migration (Manual SQL)

```powershell
# Create empty migration template
python -m alembic revision -m "custom_manual_migration"

# Edit generated file:
# - Add custom SQL in upgrade()
# - Add rollback SQL in downgrade()
```

**Template**:
```python
def upgrade():
    op.execute("""
        -- Your custom SQL here
        CREATE INDEX CONCURRENTLY idx_tasks_priority_status
        ON tasks(priority, status)
        WHERE status != 'completed';
    """)

def downgrade():
    op.execute("DROP INDEX IF EXISTS idx_tasks_priority_status;")
```

### Branching and Merging Migrations

```powershell
# Create branch point
python -m alembic revision -m "branch_feature_x" --branch-label=feature_x

# Merge branches
python -m alembic merge -m "merge_feature_x_into_main" <rev1> <rev2>
```

### Show SQL for Migration (No Execution)

```powershell
# Generate SQL for upgrade
python -m alembic upgrade head --sql > upgrade.sql

# Generate SQL for downgrade
python -m alembic downgrade -1 --sql > downgrade.sql

# Review generated SQL
type upgrade.sql
```

---

## Database Inspection Commands

### Query Alembic Version Table

```python
# query_alembic_version.py
from sqlalchemy import create_engine, text

engine = create_engine('postgresql://contextforge:contextforge@172.25.14.122:5432/taskman_v2')

with engine.connect() as conn:
    # Check if alembic_version exists
    result = conn.execute(text("""
        SELECT EXISTS (
            SELECT FROM information_schema.tables
            WHERE table_name = 'alembic_version'
        );
    """))
    exists = result.scalar()
    print(f"alembic_version table exists: {exists}")

    if exists:
        # Get current version
        result = conn.execute(text("SELECT version_num FROM alembic_version;"))
        version = result.scalar()
        print(f"Current migration version: {version}")
    else:
        print("Database has never been stamped with Alembic")
```

**Run**:
```powershell
python query_alembic_version.py
```

### List All Tables and Columns

```python
# inspect_schema.py
from sqlalchemy import create_engine, inspect

engine = create_engine('postgresql://contextforge:contextforge@172.25.14.122:5432/taskman_v2')
inspector = inspect(engine)

tables = inspector.get_table_names(schema='public')

print(f"Found {len(tables)} tables:\n")

for table in sorted(tables):
    print(f"Table: {table}")
    columns = inspector.get_columns(table, schema='public')

    for col in columns:
        nullable = "NULL" if col['nullable'] else "NOT NULL"
        print(f"  - {col['name']}: {col['type']} {nullable}")

    # Show indexes
    indexes = inspector.get_indexes(table, schema='public')
    if indexes:
        print(f"  Indexes:")
        for idx in indexes:
            cols = ', '.join(idx['column_names'])
            unique = "UNIQUE" if idx['unique'] else ""
            print(f"    - {idx['name']}: ({cols}) {unique}")

    print()
```

**Run**:
```powershell
python inspect_schema.py
```

---

## Troubleshooting

### Error: "Can't locate revision identified by 'head'"

**Cause**: `alembic_version` table doesn't exist or is empty

**Fix**:
```powershell
# Create baseline migration
python -m alembic revision -m "baseline_schema"

# Edit baseline migration to match current schema
# Then stamp database
python -m alembic stamp head
```

### Error: "Target database is not up to date"

**Cause**: Database schema doesn't match migration history

**Diagnosis**:
```powershell
# Compare migration history to database state
python -m alembic history --verbose
python inspect_schema.py

# Check for drift
python compare_schemas.py
```

**Fix**:
```powershell
# Option 1: Apply pending migrations
python -m alembic upgrade head

# Option 2: Stamp database at correct revision
python -m alembic stamp <correct_revision>
```

### Error: "FOREIGN KEY constraint failed"

**Cause**: Migration tries to create FK before referenced table exists

**Fix**: Reorder migrations or add dependency in revision file:
```python
depends_on = ['<prerequisite_revision>']
```

### Error: "Deadlock detected" (PostgreSQL)

**Cause**: Migration holds locks while other transactions are active

**Fix**:
```powershell
# Use CONCURRENTLY for index creation (doesn't block)
op.execute("CREATE INDEX CONCURRENTLY idx_name ON table(column);")

# Or run during maintenance window
```

---

## Best Practices

### 1. Always Review Autogenerated Migrations

```powershell
# Generate migration
python -m alembic revision --autogenerate -m "description"

# STOP! Review the file before applying
cat alembic\versions\<revision>_description.py

# Check for:
# - Incorrect column renames (Alembic may interpret as drop + add)
# - Missing indexes
# - Data migrations needed
# - Foreign key dependencies
```

### 2. Test Migrations in Development First

```powershell
# Upgrade test database
python -m alembic upgrade head

# Run application tests
python -m pytest tests/

# If tests pass, apply to staging/production
```

### 3. Keep Migrations Idempotent

```python
# Use IF EXISTS / IF NOT EXISTS
def upgrade():
    op.execute("CREATE TABLE IF NOT EXISTS new_table (...);")

def downgrade():
    op.execute("DROP TABLE IF EXISTS new_table;")
```

### 4. Add Data Migrations When Needed

```python
def upgrade():
    # Schema change
    op.add_column('tasks', sa.Column('complexity_score', sa.Integer()))

    # Data migration
    connection = op.get_bind()
    connection.execute(text("""
        UPDATE tasks
        SET complexity_score = CASE
            WHEN estimated_hours < 8 THEN 1
            WHEN estimated_hours < 40 THEN 2
            ELSE 3
        END;
    """))
```

### 5. Use Meaningful Migration Messages

```powershell
# ❌ BAD
python -m alembic revision -m "update"

# ✅ GOOD
python -m alembic revision -m "add_parent_audit_fields_to_action_lists"
```

---

## CI/CD Integration

### Pre-Deployment Check

```powershell
# Verify no pending migrations
$current = python -m alembic current | Out-String
$history = python -m alembic history | Out-String

if ($current -notmatch "head") {
    Write-Error "Database not at head revision!"
    exit 1
}

Write-Output "✅ Database is up-to-date"
```

### Automated Migration Application

```powershell
# Apply migrations during deployment
python -m alembic upgrade head

if ($LASTEXITCODE -ne 0) {
    Write-Error "Migration failed!"
    python -m alembic downgrade -1  # Rollback
    exit 1
}

Write-Output "✅ Migrations applied successfully"
```

---

## Emergency Procedures

### Rollback Failed Migration

```powershell
# Immediately rollback
python -m alembic downgrade -1

# Check database state
python inspect_schema.py

# Fix migration file
# Re-apply
python -m alembic upgrade head
```

### Manual Schema Fix (Last Resort)

```powershell
# Connect to PostgreSQL
wsl bash -c "PGPASSWORD=contextforge psql -h 172.25.14.122 -U contextforge -d taskman_v2"

# Apply manual fix
# taskman_v2=# ALTER TABLE tasks ADD COLUMN ...;

# Stamp database at correct revision
python -m alembic stamp <revision>
```

---

## Reference Links

- **Alembic Documentation**: https://alembic.sqlalchemy.org/
- **SQLAlchemy Migrations**: https://docs.sqlalchemy.org/en/20/core/metadata.html
- **PostgreSQL ALTER TABLE**: https://www.postgresql.org/docs/current/sql-altertable.html
- **ContextForge Database Design**: [docs/05-Database-Design-Implementation.md](05-Database-Design-Implementation.md)

---

**Maintained by**: Database/SQL Master Engineer Agent
**Last Updated**: 2025-12-25
**Status**: Active
