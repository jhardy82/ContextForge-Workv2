# Authority Modules Registry

This document declares the canonical (authoritative) modules for core workspace capabilities and the deprecation status of legacy implementations.

## Task Management

| Capability                          | Authoritative Module       | Marker Constant                 | Deprecated Alternatives          | Deprecation Event               |
| ----------------------------------- | -------------------------- | ------------------------------- | -------------------------------- | ------------------------------- |
| Tracker Tasks CRUD / Upsert / Notes | `tasks_cli.py` (repo root) | `AUTHORITY_TASKS_MODULE = True` | `python/dbcli/tasks_commands.py` | `legacy_tasks_commands_warning` |

Notes:

- All new task-related automation MUST invoke `tasks_cli.py` (Typer app `tasks_app` via `python tasks_cli.py task upsert ...`).
- Legacy sub-commands under `dbcli task` now emit a single WARN event per process and will be removed after migration.

## Structured Logging

| Capability                 | Authoritative Module    | Marker Constants                                                            | Deprecated Alternatives                              |
| -------------------------- | ----------------------- | --------------------------------------------------------------------------- | ---------------------------------------------------- |
| Unified Structured Logging | `src/unified_logger.py` | `AUTHORITY_LOGGER_MODULE = True`, `CANONICAL_LOGGER_NAME = "UnifiedLogger"` | Any ad-hoc log writers / legacy SacredGeometryLogger |

Notes:

- Import `from src.unified_logger import ulog` for JSONL event emission.
- Rotation, redaction, and evidence auto-promotion handled centrally; do NOT duplicate logic elsewhere.

## Governance

- Authority markers enable future compliance scripts to assert single-source usage.
- Introducing a competing module requires updating this registry and adding a migration plan.

## Shell Invocation Policy

- Direct Python invocation is required (no `pwsh -Command "python ..."` wrappers) unless a documented HostFallbackReason is present.
- VS Code tasks should depend on `Env: Ensure .venv` and then call the Python interpreter directly.

## Migration Tracking

- Removal target for `python/dbcli/tasks_commands.py`: after all CI and local scripts switched to tasks_cli (target date: TBD).
- Legacy logger replacements complete opportunistically; any detection of non-unified logging should create a remediation task referencing this file.

---

Generated by automation to codify authoritative surfaces.

## Wrapper Usage Metrics & Remediation Plan

The following PowerShell scripts currently invoke Python directly (acceptable) but are candidates for reduction or conversion to fully Python implementations where their primary role is orchestration:

| Script                                 | Purpose                                   | Acceptable Justification                 | Migration Action                                                     |
| -------------------------------------- | ----------------------------------------- | ---------------------------------------- | -------------------------------------------------------------------- |
| `scripts/Ensure-VenvEnforced.ps1`      | Enforce & activate .venv                  | HostPolicy enforcement / env bootstrap   | Retain (authoritative env bootstrap)                                 |
| `scripts/Run-PythonTests.ps1`          | Temporary isolated pytest run harness     | Legacy convenience wrapper               | Replace with direct `python -m pytest` task once parity test added   |
| `cli/Invoke-VelocityTracker.ps1`       | Velocity tracker orchestration            | DuckDB PS wrapper (HostFallbackReason)   | Phase out after Python CLI parity task added                         |
| `scripts/Build-DuckDbTrackerIndex.ps1` | Delegates to Python duckdb when available | Transitional dual-host support           | Convert to pure Python + minimal PS shim removal                     |
| `Run-QualityGates.ps1`                 | Composite quality gate runner             | Multi-tool orchestration (PSSA + pytest) | Decompose: Python quality orchestrator + PS gate only if SCCM needed |

No active occurrences of banned pattern `pwsh -Command "python ..."` were detected (scan via grep). Compliance status: GREEN.

### Planned Actions

1. Add pytest idempotency test for `apply_task_plan.py` (ensures safe CI reuse).
2. Introduce direct Python task for velocity tracker (mirrors `cli/Invoke-VelocityTracker.ps1`).
3. Replace `Run-PythonTests.ps1` usage in CI with tasks.json `Python: Tests (All)`.
4. Draft deprecation notice inside wrappers slated for removal (add `# DEPRECATED (Python replacement: <path>)`).
5. After two green runs with Python replacements, archive deprecated wrappers under `/archive`.

### Metrics Snapshot

| Metric                                        | Value                         |
| --------------------------------------------- | ----------------------------- |
| Total PS scripts referencing `python`         | 146 (grep scan)               |
| High-priority wrappers (orchestration-only)   | 3                             |
| Banned wrapper pattern occurrences            | 0                             |
| Authoritative Python tasks added this session | 1 (`Python: Apply Task Plan`) |

Evidence event emitted: `task_plan_applied` (enhanced fields) with created/existing counts.
