## Lazy Typer Startup Performance Gate Policy

This document defines the initial policy governing the enforcement script `python/tools/perf_gate_lazy_typer.py`.

### Objectives
1. Prevent performance regressions in Typer CLI startup when using the lazy import facade (`CF_LAZY_TYPER`).
2. Provide deterministic, machine-verifiable thresholds to fail CI early (exit code 3) on degradation.
3. Maintain transparent, reproducible evidence via structured logging (UnifiedLogger minimal baseline).

### Metrics
Collected fresh via one measurement harness invocation per pair (``--runs 1``):
| Metric | Description |
| ------ | ----------- |
| median_eager_us | Median microseconds for eager import over fresh sample set |
| median_lazy_us | Median microseconds for lazy import over fresh sample set |
| improvement_pct | `(median_eager - median_lazy) / median_eager * 100` |

### Baseline Source
`build/artifacts/perf/baseline_stats.json` (generated by `compute_lazy_typer_stats.py`). The global block is authoritative for gate comparison. Per‑set statistics (A, B, …) provide provenance but are not currently adjusted by the gate.

### Gate Rules (v1)
Let:
* `B_lazy` = baseline.global.median_lazy_us
* `B_impr` = baseline.global.improvement_pct
* `F_lazy` = fresh.median_lazy_us
* `F_impr` = fresh.improvement_pct

Parameters (defaults):
* `tolerance_pct_lazy = 0.05` (5% allowed increase)
* `allow_improvement_drop = 1.0` (absolute percentage points)

Pass conditions (both must be true):
1. `F_lazy <= B_lazy * (1 + tolerance_pct_lazy)`
2. `F_impr >= B_impr - allow_improvement_drop`

### Exit Codes
| Code | Meaning |
| ---- | ------- |
| 0 | Gate passed |
| 2 | Configuration / validation error (missing / malformed baseline, sampling failure) |
| 3 | Gate failed (threshold violation) |

### Logging Events
| Event | Purpose |
| ----- | ------- |
| session_start | Begin gate run (module, runs) |
| task_start | Fresh sample collection begins |
| decision (lazy_median_check) | Result of rule #1 |
| decision (improvement_check) | Result of rule #2 |
| artifact_emit (report) | Consolidated report (pass/fail) |
| artifact_emit (baseline_updated) | When `--update-baseline` succeeds |
| session_summary | Final status |

### Baseline Update Semantics
`--update-baseline` (opt‑in) rewrites only the `global` section (adds `updated_at`). Per‑set arrays are left untouched to retain historical variance provenance. Future iterations may add versioning (e.g., `baseline_version`).

### Rationale for Chosen Thresholds
* 5% lazy median tolerance absorbs natural system noise (observed cov ~0.28–0.41) without masking true regressions.
* 1pp improvement drop allowance protects against minor fluctuation while ensuring directional stability.
* Separate rules avoid false positives in cases where both eager and lazy shift uniformly (system-wide variance) — relative improvement safeguard ensures lazy mode still confers benefit.

### Future Enhancements (Backlog)
* Dynamic tolerance using rolling standard deviation (e.g., `B_lazy + k * stdev_lazy`).
* Pluggable checker framework (pluggy/stevedore) to add additional gates (e.g., variance cap, tail latency).
* Evidence tier activation when improvement delta > configured threshold or negative regression detected.
* Automatic slack / notification hook on failure.
* Baseline versioning & historical trending chart artifact.

### Maintenance Procedure
1. Regenerate expanded samples (≥30 per set) before intentional baseline refresh.
2. Run gate with `--update-baseline` only after confirming improvement is stable across ≥2 consecutive runs.
3. Document baseline update in CHANGELOG under `Changed` with old vs new global medians & improvement.

---
Policy version: 1.0 (2025-09-19)
