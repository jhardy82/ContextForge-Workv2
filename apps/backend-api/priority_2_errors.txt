================================================= test session starts =================================================
platform win32 -- Python 3.11.9, pytest-8.4.2, pluggy-1.6.0 -- C:\Users\James\Documents\Github\GHrepos\SCCMScripts\TaskMan-v2\backend-api\.venv\Scripts\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\James\Documents\Github\GHrepos\SCCMScripts\TaskMan-v2\backend-api
configfile: pyproject.toml
plugins: anyio-4.12.0, Faker-30.10.0, asyncio-0.26.0, cov-5.0.0, mock-3.15.1
asyncio: mode=Mode.AUTO, asyncio_default_fixture_loop_scope=function, asyncio_default_test_loop_scope=function
collecting ... collected 30 items

tests/unit/schemas/test_task_schemas.py::TestTaskCreateRequest::test_valid_task_create_request PASSED
tests/unit/schemas/test_task_schemas.py::TestTaskCreateRequest::test_task_id_pattern_validation_success PASSED
tests/unit/schemas/test_task_schemas.py::TestTaskCreateRequest::test_task_id_pattern_validation_failure FAILED
tests/unit/schemas/test_task_schemas.py::TestTaskCreateRequest::test_required_fields_validation FAILED
tests/unit/schemas/test_task_schemas.py::TestTaskCreateRequest::test_title_max_length_validation PASSED
tests/unit/schemas/test_task_schemas.py::TestTaskCreateRequest::test_estimate_points_non_negative PASSED
tests/unit/schemas/test_task_schemas.py::TestTaskCreateRequest::test_business_value_score_range FAILED
tests/unit/schemas/test_task_schemas.py::TestTaskCreateRequest::test_enum_field_validation FAILED
tests/unit/schemas/test_task_schemas.py::TestTaskCreateRequest::test_default_values PASSED
tests/unit/schemas/test_task_schemas.py::TestTaskUpdateRequest::test_partial_update_all_fields_optional PASSED
tests/unit/schemas/test_task_schemas.py::TestTaskUpdateRequest::test_update_with_multiple_fields PASSED
tests/unit/schemas/test_task_schemas.py::TestTaskUpdateRequest::test_update_validation_rules_still_apply PASSED
tests/unit/schemas/test_task_schemas.py::TestTaskResponse::test_response_from_orm_model PASSED
tests/unit/schemas/test_task_schemas.py::TestTaskResponse::test_response_serialization PASSED
tests/unit/schemas/test_schemas.py::TestProjectSchemas::test_project_create_request_valid FAILED
tests/unit/schemas/test_schemas.py::TestProjectSchemas::test_project_id_pattern_validation PASSED
tests/unit/schemas/test_schemas.py::TestProjectSchemas::test_project_update_request_partial PASSED
tests/unit/schemas/test_schemas.py::TestProjectSchemas::test_project_response_serialization PASSED
tests/unit/schemas/test_schemas.py::TestSprintSchemas::test_sprint_create_request_valid FAILED
tests/unit/schemas/test_schemas.py::TestSprintSchemas::test_sprint_id_pattern_validation PASSED
tests/unit/schemas/test_schemas.py::TestSprintSchemas::test_sprint_velocity_points_non_negative PASSED
tests/unit/schemas/test_schemas.py::TestSprintSchemas::test_sprint_update_request_partial PASSED
tests/unit/schemas/test_schemas.py::TestSprintSchemas::test_sprint_response_with_metrics PASSED
tests/unit/schemas/test_schemas.py::TestActionListSchemas::test_action_list_create_request_valid PASSED
tests/unit/schemas/test_schemas.py::TestActionListSchemas::test_action_list_with_associations PASSED
tests/unit/schemas/test_schemas.py::TestActionListSchemas::test_action_list_soft_delete_fields FAILED
tests/unit/schemas/test_schemas.py::TestActionListSchemas::test_action_list_update_request_partial PASSED
tests/unit/schemas/test_schemas.py::TestActionListSchemas::test_action_list_response_with_metadata PASSED
tests/unit/schemas/test_schemas.py::TestBaseSchemaConfiguration::test_strict_type_validation FAILED
tests/unit/schemas/test_schemas.py::TestBaseSchemaConfiguration::test_from_attributes_orm_mode FAILED

====================================================== FAILURES =======================================================
____________________________ TestTaskCreateRequest.test_task_id_pattern_validation_failure ____________________________

self = <test_task_schemas.TestTaskCreateRequest object at 0x00000209DEA9FBD0>

    def test_task_id_pattern_validation_failure(self):
        """Test task ID pattern validation with invalid patterns."""
        # Test pattern validation errors
        pattern_invalid_ids = [
            "TASK-001",  # Wrong prefix
            "T001",  # Missing hyphen
            "T-",  # No ID part
            "T-@invalid",  # Invalid character
        ]
    
        for task_id in pattern_invalid_ids:
            data = {
                "id": task_id,
                "title": "Test",
                "summary": "Summary",
                "description": "Description",
                "owner": "owner",
                "priority": Priority.P2,
                "primary_project": "P-TEST",
                "primary_sprint": "S-TEST",
            }
    
            with pytest.raises(ValidationError) as exc_info:
                TaskCreateRequest(**data)
    
            errors = exc_info.value.errors()
            assert any("pattern" in str(err).lower() for err in errors)
    
        # Test min_length validation (empty string)
        data = {
            "id": "",
            "title": "Test",
            "summary": "Summary",
            "description": "Description",
            "owner": "owner",
            "priority": Priority.P2,
            "primary_project": "P-TEST",
            "primary_sprint": "S-TEST",
        }
        with pytest.raises(ValidationError) as exc_info:
            TaskCreateRequest(**data)
        errors = exc_info.value.errors()
>       assert any("at least 1 character" in str(err).lower() for err in errors)
E       assert False
E        +  where False = any(<generator object TestTaskCreateRequest.test_task_id_pattern_validation_failure.<locals>.<genexpr> at 0x00000209DEAB6A40>)

tests\unit\schemas\test_task_schemas.py:104: AssertionError
________________________________ TestTaskCreateRequest.test_required_fields_validation ________________________________

self = <test_task_schemas.TestTaskCreateRequest object at 0x00000209DEAA4290>

    def test_required_fields_validation(self):
        """Test that required fields are validated."""
        # Missing required fields
        data = {
            "id": "T-TEST-001",
        }
    
        with pytest.raises(ValidationError) as exc_info:
            TaskCreateRequest(**data)
    
        errors = exc_info.value.errors()
        required_fields = {"title", "summary", "description", "owner", "priority", "primary_project", "primary_sprint"}
        error_fields = {err["loc"][0] for err in errors}
    
>       assert required_fields.issubset(error_fields)
E       AssertionError: assert False
E        +  where False = <built-in method issubset of set object at 0x00000209DEAB7D80>({'primary_sprint', 'summary', 'description', 'owner', 'title', 'primary_project'})
E        +    where <built-in method issubset of set object at 0x00000209DEAB7D80> = {'primary_sprint', 'summary', 'description', 'priority', 'owner', 'primary_project', 'title'}.issubset

tests\unit\schemas\test_task_schemas.py:120: AssertionError
________________________________ TestTaskCreateRequest.test_business_value_score_range ________________________________

self = <test_task_schemas.TestTaskCreateRequest object at 0x00000209DEAA5550>

    def test_business_value_score_range(self):
        """Test business_value_score must be 0-10."""
        # Test below range
        data = {
            "id": "T-TEST-001",
            "title": "Test",
            "summary": "Summary",
            "description": "Description",
            "owner": "owner",
            "priority": Priority.P2,
            "primary_project": "P-TEST",
            "primary_sprint": "S-TEST",
            "business_value_score": -1,
        }
    
        with pytest.raises(ValidationError):
            TaskCreateRequest(**data)
    
        # Test above range
        data["business_value_score"] = 11
    
>       with pytest.raises(ValidationError):
E       Failed: DID NOT RAISE <class 'pydantic_core._pydantic_core.ValidationError'>

tests\unit\schemas\test_task_schemas.py:182: Failed
__________________________________ TestTaskCreateRequest.test_enum_field_validation ___________________________________

self = <test_task_schemas.TestTaskCreateRequest object at 0x00000209DEAA5B90>

    def test_enum_field_validation(self):
        """Test enum field validation."""
        data = {
            "id": "T-TEST-001",
            "title": "Test",
            "summary": "Summary",
            "description": "Description",
            "owner": "owner",
            "priority": Priority.P1,
            "primary_project": "P-TEST",
            "primary_sprint": "S-TEST",
            "status": TaskStatus.IN_PROGRESS,
            "severity": Severity.SEV2,
            "shape": GeometryShape.CIRCLE,
        }
    
>       request = TaskCreateRequest(**data)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for TaskCreate
E       severity
E         Input should be 'critical', 'high', 'medium' or 'low' [type=enum, input_value=<Severity.SEV2: 'sev2'>, input_type=Severity]
E           For further information visit https://errors.pydantic.dev/2.12/v/enum

tests\unit\schemas\test_task_schemas.py:206: ValidationError
________________________________ TestProjectSchemas.test_project_create_request_valid _________________________________

self = <test_schemas.TestProjectSchemas object at 0x00000209DEAB1990>

    def test_project_create_request_valid(self):
        """Test creating a valid project create request."""
        data = {
            "id": "P-TEST-001",
            "name": "Test Project",
            "mission": "Test mission",
            "start_date": date(2025, 1, 1),
            "owner": "test.owner",
        }
    
        request = ProjectCreateRequest(**data)
        assert request.id == "P-TEST-001"
>       assert request.status == ProjectStatus.DISCOVERY  # Default
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AssertionError: assert <ProjectStatus.PLANNING: 'planning'> == <ProjectStatus.DISCOVERY: 'discovery'>
E         
E         - discovery
E         + planning

tests\unit\schemas\test_schemas.py:36: AssertionError
_________________________________ TestSprintSchemas.test_sprint_create_request_valid __________________________________

self = <test_schemas.TestSprintSchemas object at 0x00000209DEAB3590>

    def test_sprint_create_request_valid(self):
        """Test creating a valid sprint create request."""
        data = {
            "id": "S-2025-01",
            "name": "Sprint 1",
            "goal": "Sprint goal",
            "cadence": SprintCadence.BIWEEKLY,
            "start_date": date(2025, 1, 1),
            "end_date": date(2025, 1, 14),
            "owner": "scrum.master",
            "primary_project": "P-TEST",
        }
    
        request = SprintCreateRequest(**data)
        assert request.id == "S-2025-01"
>       assert request.status == SprintStatus.PLANNED  # Default
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AssertionError: assert <SprintStatus.PLANNING: 'planning'> == <SprintStatus.PLANNED: 'planned'>
E         
E         - planned
E         + planning

tests\unit\schemas\test_schemas.py:134: AssertionError
______________________________ TestActionListSchemas.test_action_list_soft_delete_fields ______________________________

self = <test_schemas.TestActionListSchemas object at 0x00000209DEABD7D0>

    def test_action_list_soft_delete_fields(self):
        """Test action list soft delete fields."""
        data = {
            "id": "AL-TEST",
            "title": "Action List",
            "status": "deleted",
            "parent_deleted_at": datetime(2025, 1, 1, 12, 0, 0),
            "parent_deletion_note": {"reason": "Project closed"},
            "items": [],
        }
    
>       request = ActionListCreateRequest(**data)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for ActionListCreate
E       status
E         Input should be 'active' or 'archived' [type=enum, input_value='deleted', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.12/v/enum

tests\unit\schemas\test_schemas.py:284: ValidationError
_______________________________ TestBaseSchemaConfiguration.test_strict_type_validation _______________________________

self = <test_schemas.TestBaseSchemaConfiguration object at 0x00000209DEABE590>

    def test_strict_type_validation(self):
        """Test that type coercion is enabled (strict=False)."""
>       from taskman_api.schemas.base import BaseSchema
E       ImportError: cannot import name 'BaseSchema' from 'taskman_api.schemas.base' (C:\Users\James\Documents\Github\GHrepos\SCCMScripts\TaskMan-v2\backend-api\src\taskman_api\schemas\base.py)

tests\unit\schemas\test_schemas.py:336: ImportError
______________________________ TestBaseSchemaConfiguration.test_from_attributes_orm_mode ______________________________

self = <test_schemas.TestBaseSchemaConfiguration object at 0x00000209DEABEAD0>

    def test_from_attributes_orm_mode(self):
        """Test ORM mode (from_attributes) is enabled."""
>       from taskman_api.schemas.base import BaseSchema
E       ImportError: cannot import name 'BaseSchema' from 'taskman_api.schemas.base' (C:\Users\James\Documents\Github\GHrepos\SCCMScripts\TaskMan-v2\backend-api\src\taskman_api\schemas\base.py)

tests\unit\schemas\test_schemas.py:348: ImportError

---------- coverage: platform win32, python 3.11.9-final-0 -----------
Name                                                     Stmts   Miss Branch BrPart   Cover   Missing
-----------------------------------------------------------------------------------------------------
src\taskman_api\auth.py                                     61     61      8      0   0.00%   7-246
src\taskman_api\config.py                                   62     16      6      0  67.65%   102-103, 114-115, 224-243, 249, 255, 261, 290
src\taskman_api\core\errors.py                              78     60     36      0  15.79%   31-37, 48-57, 72-78, 101-109, 134-146, 169-177, 199-205, 226-230, 253-259
src\taskman_api\core\result.py                              49     18      0      0  63.27%   34, 37, 40, 44, 48, 51, 55, 58, 62, 71, 74, 77, 81, 85, 88, 92, 95, 99
src\taskman_api\db\base.py                                   6      1      0      0  83.33%   32
src\taskman_api\db\connection_manager.py                    91     68     10      1  23.76%   66-68, 75-124, 135-165, 170-183
src\taskman_api\db\session.py                               27      8      4      0  61.29%   48-50, 63-64, 73-75, 85
src\taskman_api\dependencies.py                             45     45      0      0   0.00%   7-100
src\taskman_api\main.py                                    104    104     18      0   0.00%   6-341
src\taskman_api\middleware\__init__.py                       2      2      0      0   0.00%   7-9
src\taskman_api\middleware\logging_middleware.py            85     85     32      0   0.00%   19-272
src\taskman_api\models\action_list.py                       54     12      6      0  70.00%   33-36, 40-42, 46-48, 128, 133
src\taskman_api\models\project.py                           45      1      0      0  97.78%   91
src\taskman_api\models\sprint.py                            51      3      0      0  94.12%   44, 48, 101
src\taskman_api\repositories\__init__.py                     6      6      0      0   0.00%   7-13
src\taskman_api\repositories\action_list_repository.py      43     43     10      0   0.00%   8-112
src\taskman_api\repositories\base.py                        33     33      0      0   0.00%   7-71
src\taskman_api\repositories\project_repository.py          46     46     12      0   0.00%   7-117
src\taskman_api\repositories\sprint_repository.py           51     51     14      0   0.00%   7-131
src\taskman_api\repositories\task_repository.py             81     81     42      0   0.00%   7-240
src\taskman_api\routers\__init__.py                          7      7      0      0   0.00%   6-13
src\taskman_api\routers\action_lists.py                    109    109     26      0   0.00%   7-661
src\taskman_api\routers\agent.py                            30     30      6      0   0.00%   1-72
src\taskman_api\routers\diagnostic.py                       20     20      0      0   0.00%   5-40
src\taskman_api\routers\projects.py                         73     73     32      0   0.00%   7-143
src\taskman_api\routers\sprints.py                         108    108     52      0   0.00%   7-202
src\taskman_api\routers\tasks.py                            94     94     42      0   0.00%   7-183
src\taskman_api\schemas\action_list.py                      82      1      2      1  97.62%   243
src\taskman_api\schemas\base.py                             53      4      6      2  86.44%   22, 25-28
src\taskman_api\schemas\project.py                         163     29     26      9  75.66%   165, 185, 188-194, 213, 216-222, 231, 234-240, 247, 250-252
src\taskman_api\schemas\sprint.py                          154     24     22      8  79.55%   148, 155, 167, 170-176, 185, 189-193, 203, 206-212
src\taskman_api\schemas\task.py                            193     31     28      9  77.38%   218, 226, 238, 241-247, 258, 261-267, 276, 279-285, 293-297
src\taskman_api\services\__init__.py                         6      6      0      0   0.00%   6-12
src\taskman_api\services\action_list_service.py            159    159     42      0   0.00%   5-328
src\taskman_api\services\base.py                           117    117     24      0   0.00%   6-330
src\taskman_api\services\project_service.py                 97     97     36      0   0.00%   6-331
src\taskman_api\services\sprint_service.py                 141    141     48      0   0.00%   6-470
src\taskman_api\services\task_service.py                    91     91     28      0   0.00%   6-451
-----------------------------------------------------------------------------------------------------
TOTAL                                                     2925   1885    618     30  30.26%

8 files skipped due to complete coverage.
Coverage HTML written to dir htmlcov
Coverage JSON written to file coverage.json

FAIL Required test coverage of 70.0% not reached. Total coverage: 30.26%
=============================================== short test summary info ===============================================
FAILED tests/unit/schemas/test_task_schemas.py::TestTaskCreateRequest::test_task_id_pattern_validation_failure - assert False
 +  where False = any(<generator object TestTaskCreateRequest.test_task_id_pattern_validation_failure.<locals>.<genexpr> at 0x00000209DEAB6A40>)
FAILED tests/unit/schemas/test_task_schemas.py::TestTaskCreateRequest::test_required_fields_validation - AssertionError: assert False
 +  where False = <built-in method issubset of set object at 0x00000209DEAB7D80>({'primary_sprint', 'summary', 'description', 'owner', 'title', 'primary_project'})
 +    where <built-in method issubset of set object at 0x00000209DEAB7D80> = {'primary_sprint', 'summary', 'description', 'priority', 'owner', 'primary_project', 'title'}.issubset
FAILED tests/unit/schemas/test_task_schemas.py::TestTaskCreateRequest::test_business_value_score_range - Failed: DID NOT RAISE <class 'pydantic_core._pydantic_core.ValidationError'>
FAILED tests/unit/schemas/test_task_schemas.py::TestTaskCreateRequest::test_enum_field_validation - pydantic_core._pydantic_core.ValidationError: 1 validation error for TaskCreate
severity
  Input should be 'critical', 'high', 'medium' or 'low' [type=enum, input_value=<Severity.SEV2: 'sev2'>, input_type=Severity]
    For further information visit https://errors.pydantic.dev/2.12/v/enum
FAILED tests/unit/schemas/test_schemas.py::TestProjectSchemas::test_project_create_request_valid - AssertionError: assert <ProjectStatus.PLANNING: 'planning'> == <ProjectStatus.DISCOVERY: 'discovery'>
  
  - discovery
  + planning
FAILED tests/unit/schemas/test_schemas.py::TestSprintSchemas::test_sprint_create_request_valid - AssertionError: assert <SprintStatus.PLANNING: 'planning'> == <SprintStatus.PLANNED: 'planned'>
  
  - planned
  + planning
FAILED tests/unit/schemas/test_schemas.py::TestActionListSchemas::test_action_list_soft_delete_fields - pydantic_core._pydantic_core.ValidationError: 1 validation error for ActionListCreate
status
  Input should be 'active' or 'archived' [type=enum, input_value='deleted', input_type=str]
    For further information visit https://errors.pydantic.dev/2.12/v/enum
FAILED tests/unit/schemas/test_schemas.py::TestBaseSchemaConfiguration::test_strict_type_validation - ImportError: cannot import name 'BaseSchema' from 'taskman_api.schemas.base' (C:\Users\James\Documents\Github\GHrepos\SCCMScripts\TaskMan-v2\backend-api\src\taskman_api\schemas\base.py)
FAILED tests/unit/schemas/test_schemas.py::TestBaseSchemaConfiguration::test_from_attributes_orm_mode - ImportError: cannot import name 'BaseSchema' from 'taskman_api.schemas.base' (C:\Users\James\Documents\Github\GHrepos\SCCMScripts\TaskMan-v2\backend-api\src\taskman_api\schemas\base.py)
============================================ 9 failed, 21 passed in 2.97s =============================================
